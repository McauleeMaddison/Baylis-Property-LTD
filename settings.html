<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <meta name="description" content="Settings for Baylis Property LTD — appearance, notifications, privacy." />

  <title>Settings • Baylis Property LTD</title>

  <!-- Root-relative assets -->
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="css/style.css" />

  <!-- Default API base (override via body[data-api-base]) -->
  <script>window.API_BASE = "/api";</script>

  <!-- Shared UI (nav, mobile menu, active link, etc.) -->
  <script defer src="server/app.js"></script>
  <!-- Optional page script (if you have one); inline fallbacks handle everything otherwise -->
  <script defer src="js/settings.js"></script>

  <!-- Prefetch likely next pages -->
  <link rel="prefetch" href="index.html" />
  <link rel="prefetch" href="profile.html" />
</head>
<body class="page page--settings"
      data-required-role="resident,landlord"
      data-api-base="/api">
  <!-- Header / Navbar -->
  <header class="site-header" id="mainHeader">
    <nav class="nav" aria-label="Main">
      <div class="nav-inner container">
        <a class="logo" href="/" aria-label="Baylis Property LTD Home">
          <img src="assets/logo.png" alt="" width="26" height="26" />
          <span>Baylis Property LTD</span>
        </a>

        <button class="btn secondary hamb"
                aria-expanded="false"
                aria-controls="navLinks"
                aria-label="Toggle menu"
                data-hamb>☰</button>

        <div class="nav-links" id="navLinks" data-links>
          <a href="index.html">Dashboard</a>
          <a href="resident.html">Resident</a>
          <a href="landlord.html">Landlord</a>
          <a href="community.html">Community</a>
          <a href="profile.html">Profile</a>
          <a href="settings.html" aria-current="page">Settings</a>
          <a href="login.html">Login</a>
          <a href="register.html">Register</a>
        </div>
      </div>
    </nav>
  </header>

  <!-- Main -->
  <main id="content" class="container" tabindex="-1" style="margin-top: 1rem;">
    <header class="header">
      <h1 class="h1">Settings</h1>
      <p class="muted">Tune your experience. Changes to appearance are previewed live.</p>
    </header>

    <!-- Quick tabs (anchor style) -->
    <nav class="dashboard-buttons" aria-label="Settings Sections" style="margin-top:.75rem;">
      <a class="btn-chip" href="#general">General</a>
      <a class="btn-chip" href="#appearance">Appearance</a>
      <a class="btn-chip" href="#notifications">Notifications</a>
      <a class="btn-chip" href="#security">Security & Privacy</a>
    </nav>

    <!-- Live Preview Card -->
    <section class="dashboard-card" aria-live="polite" aria-label="Theme preview" style="margin-top:1rem;">
      <div id="previewCard">
        <h2 class="h3" id="previewTitle" style="margin-bottom:.4rem;">Preview: Baylis Card</h2>
        <p class="muted">Buttons and surfaces reflect your appearance choices below.</p>
        <div style="display:flex; gap:.5rem; margin-top:.6rem;">
          <button class="btn" id="previewBtnPrimary">Primary</button>
          <button class="btn btn-ghost" id="previewBtnGhost">Ghost</button>
        </div>
      </div>
    </section>

    <!-- Settings Form -->
    <form id="settingsForm" class="settings-form" style="margin-top:1rem;" novalidate>
      <!-- GENERAL -->
      <section id="general" class="dashboard-card">
        <h2 class="h3">General</h2>
        <p class="muted">Basic preferences for your account on this device.</p>

        <label class="checkbox" style="margin-top:.6rem;">
          <input type="checkbox" id="showTips" />
          <span>Show onboarding tips</span>
        </label>

        <div class="grid-2" style="margin-top:.6rem;">
          <label class="field" for="defaultLanding">
            <span>Default landing page</span>
            <select id="defaultLanding">
              <option value="/">Resident Dashboard</option>
              <option value="/landlord">Landlord Dashboard</option>
              <option value="/profile">Profile</option>
              <option value="/settings" selected>Settings</option>
            </select>
            <small class="muted">Used after you sign in.</small>
          </label>

          <label class="field" for="timeFormat">
            <span>Time format</span>
            <select id="timeFormat">
              <option value="24h" selected>24-hour</option>
              <option value="12h">12-hour (AM/PM)</option>
            </select>
          </label>
        </div>
      </section>

      <!-- APPEARANCE -->
      <section id="appearance" class="dashboard-card">
        <h2 class="h3">Appearance</h2>
        <p class="muted">Color, density, and theme preferences.</p>

        <label class="checkbox" style="margin-top:.6rem;">
          <input type="checkbox" id="darkModeSetting" />
          <span>Enable dark mode by default</span>
        </label>

        <div class="grid-2" style="margin-top:.6rem;">
          <label class="field" for="accentColor">
            <span>Accent color</span>
            <input type="color" id="accentColor" value="#4a90e2" />
            <small class="muted">Affects highlights and focus states.</small>
          </label>

          <label class="field" for="uiDensity">
            <span>UI density</span>
            <select id="uiDensity">
              <option value="comfortable" selected>Comfortable</option>
              <option value="compact">Compact</option>
              <option value="spacious">Spacious</option>
            </select>
          </label>
        </div>

        <div class="grid-2" style="margin-top:.6rem;">
          <label class="field" for="baseFontSize">
            <span>Base font size</span>
            <select id="baseFontSize">
              <option value="14">14px</option>
              <option value="16" selected>16px</option>
              <option value="18">18px</option>
            </select>
          </label>

          <label class="field" for="cornerRadius">
            <span>Corner radius</span>
            <input type="range" id="cornerRadius" min="6" max="18" value="12" />
            <small class="muted">Controls rounded corners on components.</small>
          </label>
        </div>
      </section>

      <!-- NOTIFICATIONS -->
      <section id="notifications" class="dashboard-card">
        <h2 class="h3">Notifications</h2>
        <p class="muted">Stay in the loop about your properties and community.</p>

        <div class="grid-2" style="margin-top:.6rem;">
          <label class="checkbox">
            <input type="checkbox" id="notifRequests" checked />
            <span>Request updates (cleaning & repair)</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" id="notifCommunity" />
            <span>Community post replies</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" id="notifDigest" />
            <span>Weekly activity digest</span>
          </label>
          <label class="field" for="digestDay">
            <span>Digest day</span>
            <select id="digestDay">
              <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
              <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
            </select>
          </label>
        </div>
      </section>

      <!-- SECURITY & PRIVACY -->
      <section id="security" class="dashboard-card">
        <h2 class="h3">Security & Privacy</h2>
        <p class="muted">Manage your password and privacy options.</p>

        <details style="margin-top:.6rem;">
          <summary><strong>Change password</strong></summary>
          <div class="grid-2" style="margin-top:.6rem;">
            <input type="password" id="currentPassword" placeholder="Current password" autocomplete="current-password" />
            <input type="password" id="newPassword" placeholder="New password" autocomplete="new-password" />
          </div>
          <input type="password" id="confirmNewPassword" placeholder="Confirm new password" style="margin-top:.6rem;" autocomplete="new-password" />
          <button type="button" id="changePasswordBtn" class="btn" style="margin-top:.6rem;">Update password</button>
          <small class="muted">Requires backend endpoint; button is wired for JSON POST.</small>
        </details>

        <div class="grid-2" style="margin-top:.8rem;">
          <label class="checkbox">
            <input type="checkbox" id="twoFA" />
            <span>Enable 2-Step Verification</span>
          </label>
          <button type="button" id="signOutAllBtn" class="btn btn-ghost">Sign out of all devices</button>
        </div>

        <div style="margin-top:.8rem;">
          <button type="button" id="exportDataBtn" class="btn btn-ghost">Export my data</button>
          <button type="button" id="clearLocalBtn" class="btn" style="background:#ef4444; color:#fff;">Clear local data</button>
        </div>
      </section>

      <!-- Form actions -->
      <section class="dashboard-card" style="display:flex; gap:.6rem; align-items:center; justify-content:flex-end;">
        <button type="button" id="resetDefaults" class="btn btn-ghost">Reset to defaults</button>
        <button type="submit" class="btn">Save Settings</button>
      </section>

      <div id="settingsMsg" class="form-msg" role="status" aria-live="polite"></div>
    </form>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>&copy; <span id="year"></span> Baylis Property LTD</small>
    </div>
  </footer>

  <!-- Inline page logic: role gate, live preview, local persistence + backend sync -->
  <script>
    (function () {
      const $  = (s, c=document) => c.querySelector(s);
      const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));
      const apiBase = document.body.getAttribute('data-api-base') || window.API_BASE || '/api';

      // Footer year
      const y = $('#year'); if (y) y.textContent = new Date().getFullYear();

      // -------- Role Gate (resident OR landlord) --------
      async function guard() {
        const allow = (document.body.getAttribute('data-required-role') || 'resident,landlord')
          .split(',').map(x => x.trim().toLowerCase());
        try {
          const r = await fetch(`${apiBase}/auth/me`, { credentials: 'include' });
          if (!r.ok) throw 0;
          const { user } = await r.json();
          if (!user || (allow.length && !allow.includes(String(user.role || '').toLowerCase()))) {
            window.location.replace('/login'); return null;
          }
          // Title personalization
          const name = user.profile?.displayName || user.email?.split('@')[0] || 'User';
          document.title = `Settings • ${name} | Baylis Property LTD`;
          return user;
        } catch { window.location.replace('/login'); return null; }
      }

      // -------- Local settings storage (namespaced) --------
      const LS_KEY = 'appSettings';
      const defaults = {
        general:   { showTips: false, defaultLanding: '/settings', timeFormat: '24h' },
        appearance:{ darkMode: false, accent: '#4a90e2', density: 'comfortable', fontSize: 16, radius: 12 },
        notify:    { requests: true, community: false, digest: false, digestDay: 'Monday' },
        security:  { twoFA: false }
      };

      function readSettings() {
        try { return Object.assign({}, defaults, JSON.parse(localStorage.getItem(LS_KEY) || '{}')); }
        catch { return JSON.parse(JSON.stringify(defaults)); }
      }
      function writeSettings(obj) {
        localStorage.setItem(LS_KEY, JSON.stringify(obj));
      }

      // -------- Apply appearance to document + preview --------
      function applyAppearance(s) {
        // document-level tokens
        document.documentElement.style.setProperty('--accent', s.accent);
        document.documentElement.style.setProperty('--radius', s.radius + 'px');
        document.documentElement.style.setProperty('--base-font-size', (s.fontSize || 16) + 'px');

        // density class
        document.documentElement.classList.remove('density-compact','density-comfortable','density-spacious');
        document.documentElement.classList.add('density-' + (s.density || 'comfortable'));

        // dark mode
        document.body.classList.toggle('dark', !!s.darkMode);

        // preview card emphasis (purely visual)
        const preview = $('#previewCard');
        if (preview) preview.style.borderRadius = s.radius + 'px';
      }

      // -------- Hydrate form from settings --------
      function fillForm(s) {
        // General
        $('#showTips').checked = !!s.general.showTips;
        $('#defaultLanding').value = s.general.defaultLanding || '/settings';
        $('#timeFormat').value = s.general.timeFormat || '24h';
        // Appearance
        $('#darkModeSetting').checked = !!s.appearance.darkMode;
        $('#accentColor').value = s.appearance.accent || '#4a90e2';
        $('#uiDensity').value = s.appearance.density || 'comfortable';
        $('#baseFontSize').value = String(s.appearance.fontSize || 16);
        $('#cornerRadius').value = String(s.appearance.radius || 12);
        // Notifications
        $('#notifRequests').checked = !!s.notify.requests;
        $('#notifCommunity').checked = !!s.notify.community;
        $('#notifDigest').checked = !!s.notify.digest;
        $('#digestDay').value = s.notify.digestDay || 'Monday';
        // Security
        $('#twoFA').checked = !!s.security.twoFA;
      }

      // -------- Live preview bindings --------
      function bindLivePreview(settings) {
        const ap = settings.appearance;
        const onChange = () => {
          ap.darkMode = $('#darkModeSetting').checked;
          ap.accent   = $('#accentColor').value;
          ap.density  = $('#uiDensity').value;
          ap.fontSize = parseInt($('#baseFontSize').value, 10) || 16;
          ap.radius   = parseInt($('#cornerRadius').value, 10) || 12;
          applyAppearance(ap);
        };
        ['#darkModeSetting','#accentColor','#uiDensity','#baseFontSize','#cornerRadius']
          .forEach(sel => $(sel)?.addEventListener('input', onChange));
        onChange();
      }

      // -------- Save to backend (non-blocking; local is source of truth for UI) --------
      async function syncSettingsToServer(settings, msgEl) {
        // Try modern endpoint first; fall back to profile/prefs if that’s what you have
        const bodies = [
          { url: `${apiBase}/settings`,            body: settings },             // preferred
          { url: `${apiBase}/profile/prefs`,       body: settings.appearance },  // example fallback
        ];
        for (const { url, body } of bodies) {
          try {
            const r = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(body)
            });
            if (r.ok) { msgEl && (msgEl.textContent = 'Settings saved.'); return true; }
          } catch {}
        }
        msgEl && (msgEl.textContent = 'Saved locally. Server sync unavailable.');
        return false;
      }

      // -------- Export helper --------
      function download(filename, text, type='application/json') {
        const blob = new Blob([text], { type });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), { href: url, download: filename });
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 400);
      }

      // -------- Wire actions --------
      function bindActions(settings) {
        const form = $('#settingsForm');
        const msg  = $('#settingsMsg');

        // Save
        form?.addEventListener('submit', async (e) => {
          e.preventDefault();
          // collect
          settings.general.showTips     = $('#showTips').checked;
          settings.general.defaultLanding = $('#defaultLanding').value;
          settings.general.timeFormat   = $('#timeFormat').value;

          settings.appearance.darkMode  = $('#darkModeSetting').checked;
          settings.appearance.accent    = $('#accentColor').value;
          settings.appearance.density   = $('#uiDensity').value;
          settings.appearance.fontSize  = parseInt($('#baseFontSize').value, 10) || 16;
          settings.appearance.radius    = parseInt($('#cornerRadius').value, 10) || 12;

          settings.notify.requests      = $('#notifRequests').checked;
          settings.notify.community     = $('#notifCommunity').checked;
          settings.notify.digest        = $('#notifDigest').checked;
          settings.notify.digestDay     = $('#digestDay').value;

          settings.security.twoFA       = $('#twoFA').checked;

          msg.textContent = 'Saving…';
          writeSettings(settings);
          applyAppearance(settings.appearance);
          await syncSettingsToServer(settings, msg);
        });

        // Reset to defaults
        $('#resetDefaults')?.addEventListener('click', () => {
          const next = JSON.parse(JSON.stringify(defaults));
          writeSettings(next);
          fillForm(next);
          applyAppearance(next.appearance);
          msg.textContent = 'Defaults restored (saved locally).';
        });

        // Change password (expects /api/auth/change-password)
        $('#changePasswordBtn')?.addEventListener('click', async () => {
          const cur = $('#currentPassword')?.value || '';
          const npw = $('#newPassword')?.value || '';
          const cpw = $('#confirmNewPassword')?.value || '';
          if (!cur || !npw || npw !== cpw) { msg.textContent = 'Please fill current/new and confirm match.'; return; }
          msg.textContent = 'Updating password…';
          try {
            const r = await fetch(`${apiBase}/auth/change-password`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ currentPassword: cur, newPassword: npw })
            });
            msg.textContent = r.ok ? 'Password updated.' : 'Password update failed.';
          } catch { msg.textContent = 'Password update failed.'; }
        });

        // Sign out of all sessions
        $('#signOutAllBtn')?.addEventListener('click', async () => {
          try {
            await fetch(`${apiBase}/auth/logout-all`, { method: 'POST', credentials: 'include' });
          } catch {}
          localStorage.removeItem('role');
          window.location.replace('/login');
        });

        // Export my data (fallback to local settings export)
        $('#exportDataBtn')?.addEventListener('click', async () => {
          try {
            const r = await fetch(`${apiBase}/profile/export`, { credentials: 'include' });
            if (r.ok) {
              const payload = await r.json();
              download(`baylis-export-${Date.now()}.json`, JSON.stringify(payload, null, 2));
              return;
            }
          } catch {}
          // fallback: export settings only
          const payload = { settings: readSettings() };
          download(`baylis-settings-${Date.now()}.json`, JSON.stringify(payload, null, 2));
        });

        // Clear local data only
        $('#clearLocalBtn')?.addEventListener('click', () => {
          localStorage.removeItem(LS_KEY);
          msg.textContent = 'Local settings cleared.';
        });
      }

      // -------- Boot --------
      (async () => {
        const user = await guard();
        if (!user) return;

        const s = readSettings();
        fillForm(s);
        bindLivePreview(s);
        bindActions(s);
      })();
    })();
  </script>

  <!-- Page micro styles -->
  <style>
    .btn { --_accent: var(--accent, #4a90e2); }
    .density-compact .dashboard-card { padding: .6rem; }
    .density-comfortable .dashboard-card { padding: 1rem; }
    .density-spacious .dashboard-card { padding: 1.4rem; }
  </style>

  <!-- Fallback: set document title from local name if available -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const n = localStorage.getItem('username');
      if (n) document.title = `Settings • ${n} | Baylis Property LTD`;
    });
  </script>
</body>
</html>

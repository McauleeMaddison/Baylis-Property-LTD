<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <meta name="description" content="Profile settings and activity for Baylis Property LTD users." />
  <title>Profile • Baylis Property LTD</title>
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="js/api-base.js"></script>
  <script defer src="js/script.js"></script>
  <link rel="prefetch" href="settings.html" />
  <link rel="prefetch" href="index.html" />
  <style>
    .profile-grid { display:grid; grid-template-columns: 1.2fr 1fr; gap: var(--space-4); margin-top: var(--space-4); }
    .profile-top { display:flex; gap: var(--space-4); align-items:flex-start; flex-wrap:wrap; }
    .profile-actions { display:flex; gap:.5rem; flex-wrap:wrap; }
    .profile-stats { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    @media (max-width: 900px) { .profile-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body class="page page--profile" data-required-role="resident,landlord" data-api-base="/api">
  <a class="skip-link" href="#content">Skip to main content</a>
  <header class="site-header" id="mainHeader">
    <nav class="nav" aria-label="Main">
      <div class="nav-inner container">
        <a class="logo" href="login.html" aria-label="Baylis Property LTD Home">
          <img src="assets/logo.png" alt="" width="26" height="26" />
          <span>Baylis Property LTD</span>
        </a>
        <button class="btn secondary hamb" aria-expanded="false" aria-controls="navLinks" aria-label="Toggle menu" data-hamb>☰</button>
        <div class="nav-links" id="navLinks" data-links data-open="false">
          <!-- Dashboard link removed (login required) -->
          <a href="resident.html" data-test="nav-resident">Resident</a>
          <a href="landlord.html" data-test="nav-landlord">Landlord</a>
          <a href="community.html" data-test="nav-community">Community</a>
          <a href="profile.html" aria-current="page" data-test="nav-profile">Profile</a>
          <a href="settings.html" data-test="nav-settings">Settings</a>
          <a href="login.html" data-test="nav-login">Login</a>
          <a href="register.html" data-test="nav-register">Register</a>
        </div>
      </div>
    </nav>
  </header>

  <main role="main" id="content" class="container" tabindex="-1">
    <header class="header">
      <p class="muted">Account</p>
      <h1 class="h1">Profile</h1>
      <p class="muted">Update your details, preferences, and review recent activity.</p>
    </header>

    <section class="dashboard-card profile-card" aria-label="Profile overview">
      <div class="profile-top">
        <div>
          <img id="profileAvatar" src="assets/logo.png" alt="Profile avatar" class="avatar profile-avatar" width="108" height="108" />
          <div>
            <input id="avatarInput" type="file" accept="image/*" class="sr-only" />
            <label class="btn btn-ghost" for="avatarInput">Change avatar</label>
          </div>
        </div>
        <div>
          <div>
            <p class="muted">Signed in as</p>
            <h2 id="profileName" class="h2">User</h2>
            <div id="profileRole" class="muted">Role</div>
          </div>
          <div class="profile-stats">
            <span class="badge" id="statRole">Role: —</span>
            <span class="badge" id="statRequests">Requests: 0</span>
            <span class="badge" id="statPosts">Posts: 0</span>
          </div>
          <div class="profile-actions">
            <a class="btn btn-ghost" href="index.html">Go to Dashboard</a>
            <a class="btn" href="settings.html">Open Settings</a>
          </div>
        </div>
      </div>
    </section>

    <section class="profile-grid" aria-label="Profile settings">
      <div>
        <section class="dashboard-card" aria-labelledby="aboutTitle">
          <div>
            <div>
              <h2 id="aboutTitle" class="h3">About</h2>
              <p class="muted">Update how your name and unit appear.</p>
            </div>
          </div>
          <form id="aboutForm">
            <div>
              <label class="field" for="aboutDisplayName">
                <span>Display name</span>
                <input id="aboutDisplayName" name="displayName" type="text" placeholder="e.g. Mac Baylis" aria-describedby="aboutMsg" />
              </label>
              <label class="field" for="aboutUnit">
                <span>Unit / Property</span>
                <input id="aboutUnit" name="unit" type="text" placeholder="e.g. Flat 3B" aria-describedby="aboutMsg" />
              </label>
            </div>
            <label class="field" for="aboutBio">
              <span>Bio</span>
              <textarea id="aboutBio" name="bio" placeholder="Tell others a little about you…" aria-describedby="aboutMsg"></textarea>
            </label>
            <div>
              <button class="btn" type="submit">Save about</button>
            </div>
            <div id="aboutMsg" class="form-msg" role="alert" aria-live="assertive" tabindex="-1"></div>
          </form>
        </section>

        <section class="dashboard-card" aria-labelledby="contactTitle">
          <div>
            <div>
              <h2 id="contactTitle" class="h3">Contact</h2>
              <p class="muted">How we can reach you.</p>
            </div>
          </div>
          <form id="contactForm">
            <div>
              <label class="field" for="contactEmail">
                <span>Email</span>
                <input id="contactEmail" name="email" type="email" placeholder="your@email.com" aria-describedby="contactMsg" />
              </label>
              <label class="field" for="contactPhone">
                <span>Phone</span>
                <input id="contactPhone" name="phone" type="tel" placeholder="+44 7123 456789" aria-describedby="contactMsg" />
              </label>
            </div>
            <label class="field" for="contactPref">
              <span>Preferred contact method</span>
              <select id="contactPref" name="preferred" aria-describedby="contactMsg">
                <option value="email">Email</option>
                <option value="phone">Phone</option>
                <option value="none">Do not contact</option>
              </select>
            </label>
            <div>
              <button class="btn" type="submit">Save contact</button>
            </div>
            <div id="contactMsg" class="form-msg" role="alert" aria-live="assertive" tabindex="-1"></div>
          </form>
        </section>

        <section class="dashboard-card" aria-labelledby="prefsTitle">
          <div>
            <div>
              <h2 id="prefsTitle" class="h3">Preferences</h2>
              <p class="muted">Notifications and privacy.</p>
            </div>
          </div>
          <form id="prefsForm">
            <div>
              <label class="checkbox">
                <input type="checkbox" id="prefEmailUpdates" name="emailUpdates" aria-describedby="prefsMsg" />
                <span>Email updates</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" id="prefCommunityVisible" name="communityVisible" aria-describedby="prefsMsg" />
                <span>Show my name on community posts</span>
              </label>
            </div>
            <div>
              <button class="btn" type="submit">Save preferences</button>
            </div>
            <div id="prefsMsg" class="form-msg" role="alert" aria-live="assertive" tabindex="-1"></div>
          </form>
        </section>
      </div>

      <aside class="dashboard-card" aria-labelledby="activityTitle">
        <h2 id="activityTitle" class="h3">Recent Activity</h2>
        <p class="muted">Latest requests and posts you’ve made.</p>

        <div>
          <h3 class="list-title">Requests</h3>
          <ul id="activityRequests" class="submission-log" aria-live="polite">
            <li class="muted">Loading…</li>
          </ul>
        </div>

        <div>
          <h3 class="list-title">Community Posts</h3>
          <ul id="activityPosts" class="post-feed" aria-live="polite">
            <li class="muted">Loading…</li>
          </ul>
        </div>

        <div>
          <a href="index.html#cleaningForm" class="btn btn-ghost">New Cleaning</a>
          <a href="index.html#repairForm" class="btn btn-ghost">New Repair</a>
          <a href="index.html#communityPostForm" class="btn">New Post</a>
        </div>
      </aside>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>&copy; <span id="year"></span> Baylis Property LTD</small>
    </div>
  </footer>

  <script>
    (function () {
      const $ = (s, ctx=document) => ctx.querySelector(s);
      const $$ = (s, ctx=document) => Array.from(ctx.querySelectorAll(s));
      const apiBase = document.body.getAttribute('data-api-base') || window.API_BASE || '/api';
      const y = $('#year'); if (y) y.textContent = new Date().getFullYear();

      const hamb = document.querySelector('[data-hamb]');
      const links = document.querySelector('[data-links]');
      if (hamb && links) {
        const setOpen = (open) => {
          hamb.setAttribute('aria-expanded', String(open));
          links.dataset.open = String(open);
          document.body.classList.toggle('nav-open', open);
        };
        hamb.addEventListener('click', () => setOpen(links.dataset.open !== 'true'));
        links.addEventListener('click', e => { if (e.target.closest('a')) setOpen(false); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') setOpen(false); });
        document.addEventListener('click', e => { if (!links.contains(e.target) && !hamb.contains(e.target)) setOpen(false); });
      }

      async function guard() {
        const allow = (document.body.getAttribute('data-required-role') || '').split(',').map(s => s.trim().toLowerCase());
        try {
          const r = await fetch(`${apiBase}/auth/me`, { credentials: 'include' });
          if (!r.ok) throw 0;
          const { user } = await r.json();
          if (!user) throw 0;

          const role = (user.role || '').toLowerCase();
          if (allow.length && !allow.includes(role)) {
            window.location.replace('/login');
            return null;
          }
          return user;
        } catch {
          window.location.replace('/login');
          return null;
        }
      }

      function hydrateHeader(user) {
        const displayName = user.profile?.displayName || user.email?.split('@')[0] || 'User';
        const role = (user.role || 'resident');
        const cap = role.charAt(0).toUpperCase() + role.slice(1);

        $('#profileName').textContent = displayName;
        $('#profileRole').textContent = cap;
        $('#statRole').textContent = `Role: ${cap}`;
        document.title = `Profile • ${displayName} | Baylis Property LTD`;

        const avatarUrl = user.profile?.avatarUrl || 'assets/logo.png';
        $('#profileAvatar').src = avatarUrl;
      }

      function hydrateForms(user) {
        $('#aboutDisplayName').value = user.profile?.displayName || '';
        $('#aboutUnit').value        = user.profile?.unit || '';
        $('#aboutBio').value         = user.profile?.bio || '';
        $('#contactEmail').value     = user.contact?.email || user.email || '';
        $('#contactPhone').value     = user.contact?.phone || '';
        $('#contactPref').value      = user.contact?.preferred || 'email';
        $('#prefEmailUpdates').checked    = !!user.prefs?.emailUpdates;
        $('#prefCommunityVisible').checked= !!user.prefs?.communityVisible;
        $('#statRequests').textContent = `Requests: ${user.stats?.requests ?? 0}`;
        $('#statPosts').textContent    = `Posts: ${user.stats?.posts ?? 0}`;
      }

      async function postJSON(url, payload, msgEl) {
        try {
          msgEl && (msgEl.textContent = 'Saving…');
          const r = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });
          if (!r.ok) throw new Error('Save failed');
          msgEl && (msgEl.textContent = 'Saved.');
        } catch (e) {
          msgEl && (msgEl.textContent = 'Could not save. Please try again.');
        }
      }
      function bindForms() {
        $('#aboutForm')?.addEventListener('submit', (e) => {
          e.preventDefault();
          const payload = {
            displayName: $('#aboutDisplayName').value.trim(),
            unit: $('#aboutUnit').value.trim(),
            bio: $('#aboutBio').value.trim()
          };
          postJSON(`${apiBase}/profile/about`, payload, $('#aboutMsg'));
        });

        $('#contactForm')?.addEventListener('submit', (e) => {
          e.preventDefault();
          const payload = {
            email: $('#contactEmail').value.trim(),
            phone: $('#contactPhone').value.trim(),
            preferred: $('#contactPref').value
          };
          postJSON(`${apiBase}/profile/contact`, payload, $('#contactMsg'));
        });

        $('#prefsForm')?.addEventListener('submit', (e) => {
          e.preventDefault();
          const payload = {
            emailUpdates: !!$('#prefEmailUpdates').checked,
            communityVisible: !!$('#prefCommunityVisible').checked
          };
          postJSON(`${apiBase}/profile/prefs`, payload, $('#prefsMsg'));
        });
      }

      function bindAvatar() {
        const input = $('#avatarInput');
        const img = $('#profileAvatar');
        if (!input || !img) return;

        input.addEventListener('change', async () => {
          const file = input.files?.[0];
          if (!file) return;

          const url = URL.createObjectURL(file);
          img.src = url;
          setTimeout(() => URL.revokeObjectURL(url), 1000);

          const fd = new FormData();
          fd.append('avatar', file);
          try {
            const r = await fetch(`${apiBase}/profile/avatar`, {
              method: 'POST',
              credentials: 'include',
              body: fd
            });
            if (!r.ok) throw 0;
          } catch {
          }
        });
      }

      async function loadActivity() {
        try {
          const r = await fetch(`${apiBase}/profile/activity`, { credentials: 'include' });
          if (!r.ok) throw 0;
          const { requests = [], posts = [] } = await r.json();

          const ulReq = $('#activityRequests');
          const ulPost = $('#activityPosts');

          const li = (html) => {
            const el = document.createElement('li'); el.innerHTML = html; return el;
          };

          ulReq.innerHTML = '';
          if (!requests.length) ulReq.innerHTML = '<li class="muted">No requests yet.</li>';
          requests.forEach(x => {
            const when = new Date(x.createdAt || Date.now()).toLocaleDateString();
            const badge = (x.status || 'open').replace('_',' ');
            ulReq.appendChild(li(
              `<strong data-field="name">${x.name || '—'}</strong> — <span data-field="info">${x.type ? `"${x.type}"` : (x.issue || 'Request')}</span>
               <span class="badge">[${badge}]</span> <span class="muted" data-field="date">${when}</span>`
            ));
          });

          ulPost.innerHTML = '';
          if (!posts.length) ulPost.innerHTML = '<li class="muted">No posts yet.</li>';
          posts.forEach(p => {
            const when = new Date(p.createdAt || Date.now()).toLocaleString();
            ulPost.appendChild(li(
              `<strong>${p.title || 'Post'}</strong><br><span class="muted">${when}</span><p>${(p.message||'').slice(0,220)}</p>`
            ));
          });
        } catch {
        }
      }

      (async () => {
        const user = await guard();
        if (!user) return;
        hydrateHeader(user);
        hydrateForms(user);
        bindForms();
        bindAvatar();
        loadActivity();
      })();
    })();
  </script>
  <style>
    .profile-avatar { border-radius: 999px; border: 2px solid rgba(255,255,255,.08); box-shadow: 0 6px 24px rgba(0,0,0,.25); }
    .list-title { font-weight: 600; margin: 0; }
  </style>
</body>
</html>

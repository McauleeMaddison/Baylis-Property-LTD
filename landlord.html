<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <meta name="description" content="Landlord portal for Baylis Property LTD – manage maintenance requests, engage with residents, oversee community communications." />
  <meta name="keywords" content="Baylis Property landlord, property management, maintenance requests, tenant communication" />
  <meta name="author" content="Baylis Property LTD" />
  <meta property="og:title" content="Landlord Portal • Baylis Property LTD" />
  <meta property="og:description" content="Manage your properties and residents with Baylis Property LTD's landlord portal." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://baylisproperty.co.uk/landlord.html" />
  <meta property="og:image" content="https://baylisproperty.co.uk/assets/logo.svg" />
  <meta name="twitter:card" content="summary" />
  <link rel="canonical" href="https://baylisproperty.co.uk/landlord.html" />

  <title>Landlord • Baylis Property LTD</title>

  <link rel="icon" href="assets/logo.svg" />
  <link rel="stylesheet" href="css/style.css" />
  <script defer src="js/script.js"></script>
  <script>window.API_BASE = '/api';</script>
  <link rel="prefetch" href="resident.html" />
</head>
<body class="page page--landlord" data-required-role="landlord" data-api-base="/api">
  <a class="skip-link" href="#content">Skip to main content</a>
  <header class="site-header" id="mainHeader">
    <nav class="nav" aria-label="Main">
      <div class="nav-inner container">
        <a class="logo" href="login.html" aria-label="Baylis Property LTD Home">
          <img src="assets/logo.png" alt="" width="26" height="26" />
          <span>Baylis Property LTD</span>
        </a>

        <button class="btn secondary hamb" aria-expanded="false" aria-controls="navLinks" aria-label="Toggle menu" data-hamb>☰</button>

        <div class="nav-links" id="navLinks" data-links data-open="false">
          <!-- Dashboard link removed (login required) -->
          <a href="resident.html" data-test="nav-resident">Resident</a>
          <a href="landlord.html" aria-current="page" data-test="nav-landlord">Landlord</a>
          <a href="community.html" data-test="nav-community">Community</a>
          <a href="profile.html" data-test="nav-profile">Profile</a>
          <a href="settings.html" data-test="nav-settings">Settings</a>
          <a href="login.html" data-test="nav-login">Login</a>
          <a href="register.html" data-test="nav-register">Register</a>
        </div>
      </div>
    </nav>
  </header>

  <main role="main" id="content" class="container" tabindex="-1" style="margin-top:1rem;">
    <header class="header">
      <h1 class="h1">Landlord</h1>
      <p class="muted">Welcome, <strong id="userWelcome">Landlord</strong>. Review requests, update statuses, and monitor community activity.</p>
    </header>

    <section class="dashboard-cards" aria-label="Overview metrics">
      <article class="dashboard-card" aria-labelledby="mOpen">
        <h3 id="mOpen">Open Requests</h3>
        <div class="metric" id="metricOpen">—</div>
        <p class="muted">Requests not yet started</p>
      </article>

      <article class="dashboard-card" aria-labelledby="mProg">
        <h3 id="mProg">In Progress</h3>
        <div class="metric" id="metricInProgress">—</div>
        <p class="muted">Work currently underway</p>
      </article>

      <article class="dashboard-card" aria-labelledby="mDone">
        <h3 id="mDone">Completed</h3>
        <div class="metric" id="metricDone">—</div>
        <p class="muted">Resolved and closed</p>
      </article>

      <article class="dashboard-card" aria-labelledby="mPosts">
        <h3 id="mPosts">Community Posts (7d)</h3>
        <div class="metric" id="metricPosts">—</div>
        <p class="muted">Recent resident updates</p>
      </article>
    </section>

    <section class="dashboard-card" aria-label="Tools" style="display:grid; gap:.75rem;">
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:.6rem; align-items:end;">
        <label for="reqSearch" class="field">
          <span>Search requests</span>
          <input id="reqSearch" type="search" placeholder="Search by name, issue or type…" inputmode="search" />
        </label>
        <label for="filterType" class="field">
          <span>Filter by type</span>
          <select id="filterType" title="Filter by type">
            <option value="all" selected>All types</option>
            <option value="cleaning">Cleaning</option>
            <option value="repair">Repair</option>
          </select>
        </label>
        <label for="filterStatus" class="field">
          <span>Filter by status</span>
          <select id="filterStatus" title="Filter by status">
            <option value="all" selected>All status</option>
            <option value="open">Open</option>
            <option value="in_progress">In Progress</option>
            <option value="done">Done</option>
          </select>
        </label>
      </div>
      <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
        <button type="button" id="btnRefresh" class="btn btn-ghost">Refresh</button>
        <button type="button" id="btnExport" class="btn btn-ghost">Export CSV</button>
      </div>
    </section>

    <section class="dashboard-cards" aria-label="Requests">
      <article class="dashboard-card">
        <h3>Cleaning Requests</h3>
        <ul id="allCleaningRequests" class="submission-log" aria-live="polite">
          <li class="muted">Loading…</li>
        </ul>
      </article>

      <article class="dashboard-card">
        <h3>Repair Requests</h3>
        <ul id="allRepairRequests" class="submission-log" aria-live="polite">
          <li class="muted">Loading…</li>
        </ul>
      </article>
    </section>

    <section class="dashboard-card" aria-label="Community posts">
      <h3>Community Posts</h3>
      <ul id="allCommunityPosts" class="post-feed" aria-live="polite">
        <li class="muted">Loading…</li>
      </ul>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>&copy; <span id="year"></span> Baylis Property LTD</small>
      <span class="dot">&middot;</span>
      <a href="community.html">Community</a>
      <span class="dot">&middot;</span>
      <a href="settings.html">Settings</a>
    </div>
  </footer>

  <script>
    (function () {
      const $ = (sel, ctx=document) => ctx.querySelector(sel);
      const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

      $('#year').textContent = new Date().getFullYear();

      const hamb = document.querySelector('[data-hamb]');
      const links = document.querySelector('[data-links]');
      if (hamb && links) {
        const setOpen = (open) => {
          hamb.setAttribute('aria-expanded', String(open));
          links.dataset.open = String(open);
          document.body.classList.toggle('nav-open', open);
        };
        hamb.addEventListener('click', () => setOpen(links.dataset.open !== 'true'));
        links.addEventListener('click', (e) => { if (e.target.closest('a')) setOpen(false); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') setOpen(false); });
        document.addEventListener('click', (e) => { if (!links.contains(e.target) && !hamb.contains(e.target)) setOpen(false); });
      }

      const apiBase = document.body.getAttribute('data-api-base') || window.API_BASE || '/api';

      async function ensureLandlord() {
        const required = document.body.getAttribute('data-required-role');
        if (!required) return;
        try {
          const r = await fetch(`${apiBase}/auth/me`, { credentials: 'include' });
          if (!r.ok) throw new Error('not-auth');
          const { user } = await r.json();
          if (user?.role !== required) {
            window.location.href = '/login';
            return;
          }
          $('#userWelcome').textContent = user.email || 'Landlord';
        } catch {
          window.location.href = '/login';
        }
      }

      function recomputeMetrics() {
        const ulClean  = $('#allCleaningRequests');
        const ulRepair = $('#allRepairRequests');
        const ulPosts  = $('#allCommunityPosts');

        const allLis = [...(ulClean?.children || []), ...(ulRepair?.children || [])]
          .filter(li => !li.classList.contains('muted'));

        const map = { open: 0, in_progress: 0, done: 0 };
        allLis.forEach(li => {
          const badge = li.querySelector('.badge')?.textContent?.toLowerCase() || '';
          if (badge.includes('in progress')) map.in_progress++;
          else if (badge.includes('done'))    map.done++;
          else if (badge.includes('open'))    map.open++;
        });

        $('#metricOpen').textContent       = map.open ?? 0;
        $('#metricInProgress').textContent = map.in_progress ?? 0;
        $('#metricDone').textContent       = map.done ?? 0;
        $('#metricPosts').textContent      = (ulPosts?.children?.length || 0) - (ulPosts?.querySelectorAll('.muted').length || 0);
      }

      function applyFilters() {
        const q = ($('#reqSearch')?.value || '').toLowerCase();
        const t = ($('#filterType')?.value || 'all');
        const s = ($('#filterStatus')?.value || 'all').replace('_', ' ');

        const filterList = (ul, typeLabel) => {
          if (!ul) return;
          $$('#' + ul.id + ' > li').forEach(li => {
            if (li.classList.contains('muted')) return;
            const text = li.textContent.toLowerCase();
            const status = li.querySelector('.badge')?.textContent?.toLowerCase() || '';
            let ok = true;
            if (q && !text.includes(q)) ok = false;
            if (t !== 'all' && t !== typeLabel) ok = false;
            if (s !== 'all' && !status.includes(s)) ok = false;
            li.style.display = ok ? '' : 'none';
          });
        };
        filterList($('#allCleaningRequests'), 'cleaning');
        filterList($('#allRepairRequests'),   'repair');
      }

      function exportCSV() {
        const rows = [['Type','Name','Details','Date/Info','Status']];
        const harvest = (ul, type) => {
          if (!ul) return;
          $$('#' + ul.id + ' > li').forEach(li => {
            if (li.classList.contains('muted') || li.style.display === 'none') return;
            const name  = li.querySelector('[data-field="name"]')?.textContent?.trim() || '';
            const info  = li.querySelector('[data-field="info"]')?.textContent?.trim() || '';
            const date  = li.querySelector('[data-field="date"]')?.textContent?.trim() || '';
            const stat  = (li.querySelector('.badge')?.textContent || '').trim();
            rows.push([type, name, info, date, stat]);
          });
        };
        harvest($('#allCleaningRequests'), 'cleaning');
        harvest($('#allRepairRequests'),   'repair');

        const csv = rows.map(r => r.map(v => {
          const s = String(v ?? '');
          return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        }).join(',')).join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), { href: url, download: `baylis-requests-${Date.now()}.csv` });
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 500);
      }

      $('#reqSearch')?.addEventListener('input',  applyFilters);
      $('#filterType')?.addEventListener('change', applyFilters);
      $('#filterStatus')?.addEventListener('change', applyFilters);
      $('#btnRefresh')?.addEventListener('click', () => window.location.reload());
      $('#btnExport')?.addEventListener('click', exportCSV);

      const obs = new MutationObserver(() => { applyFilters(); recomputeMetrics(); });
      ['#allCleaningRequests', '#allRepairRequests', '#allCommunityPosts'].forEach(sel => {
        const el = $(sel);
        if (el) obs.observe(el, { childList: true, subtree: true });
      });

      ensureLandlord();
      applyFilters();
      recomputeMetrics();
    })();
  </script>

  <style>
    .metric { font-size: 1.8rem; font-weight: 700; }
  </style>
</body>
</html>
